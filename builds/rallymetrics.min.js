(function(){function a(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=m[a])});16>e;)b[d+e++]=0;return b}function b(a,b){var c=b||0,d=l;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function c(a,c,d){var e=c&&d||0,f=c||[];a=a||{};var g=null!=a.clockseq?a.clockseq:q,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:s+1,j=h-r+(i-s)/1e4;if(0>j&&null==a.clockseq&&(g=g+1&16383),(0>j||h>r)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");r=h,s=i,q=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[e++]=k>>>24&255,f[e++]=k>>>16&255,f[e++]=k>>>8&255,f[e++]=255&k;var l=h/4294967296*1e4&268435455;f[e++]=l>>>8&255,f[e++]=255&l,f[e++]=l>>>24&15|16,f[e++]=l>>>16&255,f[e++]=g>>>8|128,f[e++]=255&g;for(var m=a.node||p,n=0;6>n;n++)f[e+n]=m[n];return c?c:b(f)}function d(a,c,d){var f=c&&d||0;"string"==typeof a&&(c="binary"==a?new k(16):null,a=null),a=a||{};var g=a.random||(a.rng||e)();if(g[6]=15&g[6]|64,g[8]=63&g[8]|128,c)for(var h=0;16>h;h++)c[f+h]=g[h];return c||b(g)}var e,f=this;if("function"==typeof require)try{var g=require("crypto").randomBytes;e=g&&function(){return g(16)}}catch(h){}if(!e&&f.crypto&&crypto.getRandomValues){var i=new Uint8Array(16);e=function(){return crypto.getRandomValues(i),i}}if(!e){var j=new Array(16);e=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),j[b]=a>>>((3&b)<<3)&255;return j}}for(var k="function"==typeof Buffer?Buffer:Array,l=[],m={},n=0;256>n;n++)l[n]=(n+256).toString(16).substr(1),m[l[n]]=n;var o=e(),p=[1|o[0],o[1],o[2],o[3],o[4],o[5]],q=16383&(o[6]<<8|o[7]),r=0,s=0,t=d;if(t.v1=c,t.v4=d,t.parse=a,t.unparse=b,t.BufferClass=k,"function"==typeof define&&define.amd)define(function(){return t});else if("undefined"!=typeof module&&module.exports)module.exports=t;else{var u=f.uuid;t.noConflict=function(){return f.uuid=u,t},f.uuid=t}}).call(this),function(a,b){"object"==typeof exports?module.exports=b(require("underscore")):"function"==typeof define&&define.amd?define(["underscore"],b):a.RallyMetrics=b(a._)}(this,function(a){var b=function(b){return{underscore:a}[b]};return(b=function c(a,d,e){function f(h,i){if(!d[h]){if(!a[h]){var j="function"==typeof b&&b;if(!i&&j)return j(h,!0);if(g)return g(h,!0);throw new Error("Cannot find module '"+h+"'")}var k=d[h]={exports:{}};a[h][0].call(k.exports,function(b){var c=a[h][1][b];return f(c?c:b)},k,k.exports,c,a,d,e)}return d[h].exports}for(var g="function"==typeof b&&b,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b){var c=a("underscore"),d=a("./batchSender"),e=window.uuid,f=25,g="__clientMetricsCurrentEventId__",h="__clientMetricsID__",i=function(a){c.extend(this,a),this._pendingEvents=[],this._browserTabId=this._getUniqueId(),this._startingTime=(new Date).getTime(),this._loadedComponents=[],this._errorCount=0,this.errorLimit=this.errorLimit||f,this.handlers=this.handlers||[],this.sender=this.sender||new d({keysToIgnore:["cmp","component"],beaconUrl:a.beaconUrl,emitWarnings:a.emitWarnings}),c.isFunction(this.sender.getMaxLength)&&(this.maxErrorLength=Math.floor(.9*this.sender.getMaxLength())),c.isNumber(this.flushInterval)&&(this._flushIntervalId=window.setInterval(c.bind(this.sendAllRemainingEvents,this),this.flushInterval))};i.prototype.destroy=function(){this._flushIntervalId&&window.clearInterval(this._flushIntervalId)},i.prototype.startSession=function(a,b){this._pendingEvents=[],this._sessionStartTime=this._getRelativeTime(),this.sendAllRemainingEvents(),this._defaultParams=b,this._errorCount=0,this._loadedComponents=[]},i.prototype.recordAction=function(a){var b=a.component;delete a.component;var d=this._getUniqueId(),e=this._getRelativeTime(a.startTime),f=this._startEvent(c.defaults({eType:"action",cmp:b,cmpH:this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:d,tId:d,status:"Ready",cmpType:this.getComponentType(b),start:e,stop:e},a.miscData));this._currentUserActionEventId=f.eId,this._finishEvent(f)},i.prototype.recordError=function(a,b){if(this._currentUserActionEventId&&this._errorCount<this.errorLimit){++this._errorCount;var d=a||"unknown error";this.maxErrorLength&&(d=d.substring(0,this.maxErrorLength));var e=this._getRelativeTime(),f=this._startEvent(c.defaults({eType:"error",error:d,eId:this._getUniqueId(),tId:this._currentUserActionEventId,start:e,stop:e},b));this._finishEvent(f),this.sendAllRemainingEvents()}},i.prototype.recordComponentReady=function(a){if(!c.isUndefined(this._sessionStartTime)){var b=a.component,d=this._getHierarchyString(b),e=this._loadedComponents.indexOf(d)>-1;if(!e){this._loadedComponents.push(d);var f=this._startEvent(c.defaults({eType:"load",start:this._sessionStartTime,stop:this._getRelativeTime(a.stopTime),eId:this._getUniqueId(),tId:this._currentUserActionEventId,pId:this._currentUserActionEventId,cmpType:this.getComponentType(b),cmpH:d,eDesc:"component ready",componentReady:!0},a.miscData));this._finishEvent(f)}}},i.prototype.beginLoad=function(a){var b=a.component;if(this._currentUserActionEventId&&!b[g+"load"]){var d=this._getRelativeTime(a.startTime),e=this._getUniqueId();b[g+"load"]=e;var f=c.defaults({eType:"load",cmp:b,cmpH:this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:e,cmpType:this.getComponentType(b),tId:this._currentUserActionEventId,pId:this._findParentId(b,this._currentUserActionEventId),start:d},a.miscData);this._startEvent(f)}},i.prototype.endLoad=function(a){var b=a.component;if(this._currentUserActionEventId){var d=b[g+"load"];if(d){delete b[g+"load"];var e=this._findPendingEvent(d);e&&(a.stop=this._getRelativeTime(a.stopTime),this._shouldRecordEvent(e,a)&&this._finishEvent(e,c.extend({status:"Ready"},a)))}}},i.prototype.beginDataRequest=function(a,b,d){var e;if(a&&this._currentUserActionEventId){var f=this._getUniqueId(),h=this._currentUserActionEventId,i=this._findParentId(a,this._currentUserActionEventId),j=this._getUniqueId();a[g+"dataRequest"+j]=f,this._startEvent(c.defaults({eType:"dataRequest",cmp:a,cmpH:this._getHierarchyString(a),url:this._getUrl(b),cmpType:this.getComponentType(a),cmpId:this._getComponentId(a),eId:f,tId:h,pId:i},d)),e={requestId:j,xhrHeaders:{"X-Trace-Id":h,"X-Parent-Id":f}}}return e},i.prototype.endDataRequest=function(a,b,c){if(a&&this._currentUserActionEventId){var d=a[g+"dataRequest"+c],e=this._findPendingEvent(d);if(!e)return;var f={status:"Ready",stop:this._getRelativeTime()},h=this._getRallyRequestId(b);h&&(f.rallyRequestId=h),this._finishEvent(e,f)}},i.prototype.sendAllRemainingEvents=function(){this.sender.flush()},i.prototype.getComponentType=function(a){return this._getFromHandlers(a,"getComponentType")},i.prototype._getUniqueId=function(){return e.v4()},i.prototype._getRelativeTime=function(a){return(a||(new Date).getTime())-this._startingTime},i.prototype._finishEvent=function(a,b){var d=c.defaults(b||{},a,this._defaultParams,this._guiTestParams);this._pendingEvents=c.without(this._pendingEvents,a),this.sender.send(d)},i.prototype._startEvent=function(a){if(a.bts=(new Date).getTime(),a.tabId=this._browserTabId,c.isNumber(a.start)||(a.start=this._getRelativeTime()),a.cmp){var b=this._getFromHandlers(a.cmp,"getAppName");b&&(a.appName=b)}return this._pendingEvents.push(a),a},i.prototype._getFromHandlers=function(a,b){var d=null;return c.each(this.handlers,function(c){return d=c[b](a),!d}),d},i.prototype._findParentId=function(a,b){var d=this._getFromHandlers(a,"getComponentHierarchy")||[],e=b;return c.each(d,function(d){var f=c.findLast(this._pendingEvents,function(c){return"dataRequest"!==c.eType&&(c.cmp===d||c.cmp===a)&&c.tId===b});return f?(e=f.eId,!1):void 0},this),e},i.prototype._getComponentId=function(a){return a[h]||(a[h]=this._getUniqueId()),a[h]},i.prototype._getHierarchyString=function(a){var b=this._getFromHandlers(a,"getComponentHierarchy");if(!b)return"none";var d=c.map(b,this.getComponentType,this);return c.compact(d).join(":")},i.prototype._getUrl=function(a){if(!a)return"unknown";var b,c="webservice/",d=a.indexOf(c);if(d>-1){b=a.indexOf("?",d),0>b&&(b=a.length);var e=c.length;return a.substring(d+e,b)}return b=a.indexOf("?"),0>b?a:a.substring(0,b)},i.prototype._getRallyRequestId=function(a){var b="RallyRequestID";if(a){if(c.isString(a))return a;if(c.isObject(a.responseHeaders))return a.responseHeaders.RallyRequestID;if(c.isFunction(a.getResponseHeader))return a.getResponseHeader(b);if(c.isObject(a.getResponseHeader))return a.getResponseHeader[b];if(c.isFunction(a.headers))return a.headers(b)}},i.prototype._findPendingEvent=function(a){return c.find(this._pendingEvents,{eId:a})},i.prototype._shouldRecordEvent=function(a,b){return b.whenLongerThan&&b.stop-a.start<=b.whenLongerThan?(this._pendingEvents=c.without(this._pendingEvents,a),!1):!0},b.exports=i},{"./batchSender":2}],2:[function(a,b){var c=a("underscore"),d=a("./util"),e=1700,f=2e3,g=function(a){c.defaults(this,a,{keysToIgnore:[],minLength:e,maxLength:f,beaconUrl:"https://trust.f4tech.com/beacon/",emitWarnings:!1}),this._eventQueue=[]};g.prototype.send=function(a){this._eventQueue.push(this._cleanEvent(a)),this._sendBatches()},g.prototype.flush=function(){this._sendBatches(!0)},g.prototype.getPendingEvents=function(){return this._eventQueue},g.prototype.getMaxLength=function(){return this.maxLength},g.prototype._sendBatches=function(a){for(var b;b=this._getNextBatch(a);)this._sendBatch(b)},g.prototype._cleanEvent=function(a){return c.omit(a,this.keysToIgnore)},g.prototype._getNextBatch=function(a){var b,d={},e=[],f=this._getUrl()+"?",g=0;return c.each(this._eventQueue,function(a,h){var i=this._appendIndexToKeys(a,h),j=c.extend(d,i),k=f+this._toQueryString(j);return++g,k.length<this.maxLength?(e.push(a),b=k,d=j,void 0):(1===g&&this.emitWarnings&&window.console&&window.console.warn&&console.warn("Client metrics: an event is too big to send",a),!1)},this),c.isEmpty(e)||!a&&b.length<this.minLength?null:{url:b,events:e}},g.prototype._appendIndexToKeys=function(a,b){return c.transform(a,function(a,c,d){a[d+"."+b]=c})},g.prototype._sendBatch=function(a){a&&(this._makeGetRequest(a.url),this._eventQueue=c.difference(this._eventQueue,a.events))},g.prototype._getUrl=function(){return this.beaconUrl},g.prototype._removeImageFromDom=function(){d.removeEventHandler(this,"load",this._imgCallback),d.removeEventHandler(this,"error",this._imgCallback),d.removeFromDom(this)},g.prototype._toQueryString=function(a){return c.map(a,function(a,b){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&")},g.prototype._makeGetRequest=function(a){var b=document.createElement("img");b.style.width=0,b.style.height=0,b.style.display="none",b._imgCallback=c.bind(this._removeImageFromDom,b),d.addEventHandler(b,"load",b._imgCallback,!1),d.addEventHandler(b,"error",b._imgCallback,!1),document.body.appendChild(b),b.src=a},b.exports=g},{"./util":5}],"N+UuJT":[function(a,b){b.exports={Aggregator:a("./aggregator"),BatchSender:a("./batchSender"),Util:a("./util"),WindowErrorListener:a("./windowErrorListener")}},{"./aggregator":1,"./batchSender":2,"./util":5,"./windowErrorListener":6}],RallyMetrics:[function(a,b){b.exports=a("N+UuJT")},{}],5:[function(a,b){!function(){var c=a("underscore"),d={addEventHandler:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c)},removeEventHandler:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent&&a.detachEvent("on"+b,c)},removeFromDom:function(a){c.isFunction(a.remove)?a.remove():a.parentNode&&a.parentNode.removeChild(a)}};b.exports=d}()},{}],6:[function(a,b){!function(){var c=a("underscore"),d=a("./util"),e=!0,f=c.template("<%= message %>, <%= filename %>:<%= lineNumber %>"),g=c.template("onerror::<%= message %>, <%= filename %>:<%= lineNumber %>"),h=function(a,b){var f=c.isBoolean(b)?b:e;this.aggregator=a,f?(this._originalWindowOnError=window.onerror,window.onerror=c.bind(this._windowOnError,this)):d.addEventHandler(window,"error",c.bind(this._onUnhandledError,this),!1)};c.extend(h.prototype,{_windowOnError:function(a,b,d,e,g){c.isFunction(this._originalWindowOnError)&&this._originalWindowOnError.call(window,a,b,d);var h=f({message:a||"unknown message",filename:b||"??",lineNumber:c.isNumber(d)?d:"??"}),i={};e&&(i.columnNumber=e),g&&g.stack&&(i.stack=g.stack.substring(0,1e3)),this.aggregator.recordError(h,i)},_onUnhandledError:function(a){var b;b=a.browserEvent?g({message:a.browserEvent.message||"unknown message",filename:a.browserEvent.filename||"??",lineNumber:a.browserEvent.lineno||"??"}):"onerror::"+(a.message||"unknown error"),this.aggregator.recordError(b)}}),b.exports=h}()},{"./util":5}]},{},["N+UuJT"]))("RallyMetrics")});